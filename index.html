<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Collaborative editing + in-place math</title>

    <script src="CodeMirror/lib/codemirror.js"></script>
    <script src="CodeMirror/mode/markdown/markdown.js"></script>
    <script src="CodeMirror-MathJax/render-math.js"></script>

    <link rel="stylesheet" href="CodeMirror/lib/codemirror.css">

    <script src="https://c328740.ssl.cf1.rackcdn.com/mathjax/2.2-latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true,
          preview: "none"
        },
      });
    </script>

    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <!-- hack: use prebuilt example/firepad.js to allow running directly from git -->
    <script src="firepad/examples/firepad.js"></script>
    <link rel="stylesheet" href="firepad/examples/firepad.css"/>

    <style>
      .warning { color: orange }

      @media print { .header { display: none } }

      @media screen { .CodeMirror { border: 1px solid silver; } }
      @media print { .CodeMirror { border: 1px none; } }
      .CodeMirror { font-family: serif; }
      .cm-header { font-size: 150%; line-height: 200%; }

      .firepad { height: 100% }
      .firepad .CodeMirror { position: relative; }
    </style>
  </head>

  <body>
    <!-- TODO: clean content/CSS. -->
    <div class="header">
      $\binom{\mathcal{Math}}{\text{down}}:$
      <h1 style="display: inline">
        Collaborative markdown + math |
        <a href="https://github.com/cben/mathdown/issues" class="warning">
          ⚠ Alpha quality! ⚠
        </a> |
        <a href="https://github.com/cben/mathdown">Source</a>
        <span style="float: right">
          <a href="?doc=help" target="_blank">Help</a> |
          <a href="javascript:newPad()">New document</a>
        </span>
      </h1>
    </div>

    <form><textarea id="code" name="code"></textarea></form>
    <script id="script">
      "use strict";

      var editor = CodeMirror.fromTextArea(document.getElementById("code"),
                                           {lineNumbers: false,
                                            lineWrapping: true,
                                            mode: {name: "markdown",
                                                   underscoresBreakWords: false}});

      function locationQueryParams() {
        /* If more is needed, use https://github.com/medialize/URI.js */
        var queryParts = window.location.search.replace(/^\?/g, "").split("&");
        var params = {};
        for(var i = 0; i < queryParts.length; i++) {
          var keyval = queryParts[i].split("=");
          params[decodeURIComponent(keyval[0])] = decodeURIComponent(keyval[1] || "");
        }
        return params;
      }

      // Return an int in [0, 62).
      var random62 = (window.crypto && window.crypto.getRandomValues) ?
        function() {
          var buf = new Uint8Array(1);
          var n;
          do {
            window.crypto.getRandomValues(buf);
            n = (buf[0] % 64);
          } while(n >= 62);
          return n;
        }
        :
        function() {
          // Math.random is pathetic on most browsers, though some initialize
          // with secure seed: http://stackoverflow.com/a/18507748/239657
          return Math.floor(Math.random() * 62);
        };

      function randomBase62(length) {
        var base62 = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        var text = "";
        for(var i=0; i < length; i++)
          text += base62.charAt(random62());
        return text;
      }

      function newPad() {
        var doc = randomBase62(11);  // 62**11 ~= 2**65.
        window.open("?doc=" + doc, "_blank");
      }

      var doc = locationQueryParams()["doc"];
      var firepadsRef = new Firebase("https://mathdown-alpha.firebaseIO.com/firepads");
      var firepadRef = firepadsRef.child(doc);
      console.log("firebase ref:", firepadRef.toString());

      var firepad =  Firepad.fromCodeMirror(firepadRef, editor);
      firepad.on("ready", function() {
        if (firepad.isHistoryEmpty()) {
          firepad.setText(
            "# Welcome\n" +
            "Save the document's (random-looking) address - " +
            "you'll not have any other way to access it!  " +
            "Share it with friends to collaborate.\n" +
            "\n" +
            "Use Markdown and $\LaTeX$ syntaxes (see **Help** link above).  " +
            "To edit formulas just enter them with arrow keys.\n" +
            // HACK: Pad the editor with a few emty lines so it looks
            // more inviting to write in.
            "\n" +
            "\n"
          );
        }

        /* TODO: Race condition with early typing? */
        CodeMirror.renderMath(editor, MathJax);
      });
    </script>
  </body>
</html>
